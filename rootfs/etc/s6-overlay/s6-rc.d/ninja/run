#!/command/with-contenv bashio
# ==============================================================================
# Home Assistant Add-on: Invoice Ninja
# Start the original docker-entrypoint and supervisord under s6
# ==============================================================================

bashio::log.info "Setting up Invoice Ninja environment..."

# --- APP URL ---
if bashio::addon.ingress_url; then
    export APP_URL=$(bashio::addon.ingress_url)
    bashio::log.info "APP_URL dynamically set to ${APP_URL}"
else
    export APP_URL="http://localhost:8080"
    bashio::log.warning "Could not fetch Ingress URL, defaulting to localhost:8080"
fi

# --- Environment Variables ---
export APP_KEY=$(bashio::config 'app_key')
export DB_HOST=$(bashio::config 'db_host')
export DB_DATABASE=$(bashio::config 'db_database')
export DB_USERNAME=$(bashio::config 'db_username')
export DB_PASSWORD=$(bashio::config 'db_password')

# --- Basic Debug Output ---
bashio::log.info "Checking database connection to ${DB_HOST}..."
if ! ping -c 1 -W 1 "${DB_HOST}" >/dev/null 2>&1; then
    bashio::log.error "Database host ${DB_HOST} not reachable! Check your configuration."
else
    bashio::log.info "Database host reachable."
fi

bashio::log.info "Verifying APP_KEY..."
if [ -z "$APP_KEY" ]; then
    bashio::log.warning "APP_KEY is missing! Generate one using:"
    bashio::log.warning "  docker run --rm invoiceninja/invoiceninja php artisan key:generate --show"
else
    bashio::log.info "APP_KEY set. âœ…"
fi

# --- Move to working directory ---
cd /var/www/app || exit 1

bashio::log.info "Starting Invoice Ninja web server..."
bashio::log.info "Access should be available through Ingress or http://<HA-IP>:8080"

exec php artisan serve --host=0.0.0.0 --port=8080
